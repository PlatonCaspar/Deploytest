{%- extends "base.html" %}
{%- import 'bootstrap/wtf.html' as wtf %}

{% block title %}
    {{ super() }}
    {% if g_board | safe %}
        {{ g_board.code }} {{ "Ver: "+ g_board.version }}
        {#Hier kommt die Struktur wie die Daten aus der Datenbank angezeigt werden sollen.#}
    {% endif %}


{%- endblock %}



{% block content -%}

    <div class="well well-sm">
        <div class="media">
            <div class="media-left media-middle">
                {% if g_board.project.project_default_image_path is none %}
                <img
                    src="/static/staticPictures/logo.jpg"
                    class="media-object thumbnail" alt="default_project_image"
                    style="width: 120px">
                {% else %}
                <img
                    src="{{ g_board.project.project_default_image_path|replace('\\','/') }}"
                    class="media-object thumbnail" alt="default_project_image"
                    style="width: 120px">
                {% endif %}
            </div>
            <div class="media-body">
                <div class="media-heading">
                    <h4>{{ g_board.project.project_name }}

                    </h4>
                </div>
                {{ g_board.project.project_description }}
            </div>

        </div>
    </div>
    {% if g_board %}

        <div class="panel">
            <div class="page-header">
                <h3>Board Comments
                    <small>{{ "("+g_board.code|string+")" }}</small>
                </h3>
            </div>
            {% if current_user.username!='Guest' %}
                <button type="button" class="btn btn-default center-block" data-toggle="modal"
                        data-target="#addModal"><span
                        class="glyphicon glyphicon-comment "></span></button>

                <br><br>
            {% endif %}
            {% if history %}



                {% for row in history %}
                    {% set modal_id= row.id %}


                    <div class="panel-default panel-collapse" id="comment_id{{ row.id|string }}">

                        <div class="panel-body">
                            <div class="row">
                                {% if row.data_objects %}
                                    {% set pics=row.data_objects %}

                                    {% for pic in pics %}
                                        {% if '.jpg' in pic.file_path|lower or '.jpeg' in pic.file_path|lower or '.bmp' in pic.file_path|lower %}
                                            <div class=" col-xs-2 col-md-2">

                                                <div class="thumbnail">
                                                    <a href="/static/Pictures/{{ pic.file_path }}">
                                                        <img src="/static/Pictures/{{ pic.file_path }}" style="width: 100%">
                                                    </a>
                                                    <div class="caption">
                                                        {% if current_user.is_authenticated %}
                                                            <form class=""
                                                                  action="{{ url_for('delete_history_image', img_id=pic.id, board_id=g_board.code) }}"
                                                                  method="post">
                                                                <button class="btn btn-default btn-sm" type="button"
                                                                        data-toggle="collapse"
                                                                        data-target="#{{ pic.id }}"
                                                                        aria-expanded="false"
                                                                        aria-controls="{{ pic.id }}"><span
                                                                        class="glyphicon glyphicon-remove"></span>
                                                                </button>
                                                                <div class="collapse" id="{{ pic.id }}">
                                                                    <div class="">
                                                                        <br><br>
                                                                        <button class="btn btn-danger btn-sm btn-block"
                                                                                type="submit"><span
                                                                                class="glyphicon glyphicon-ok pull-left"></span>
                                                                            <strong>Delete?</strong>
                                                                        </button>
                                                                    </div>
                                                                </div>

                                                            </form>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>

                                        {% else %}

                                            <div class=" col-xs-2 col-md-2">

                                                <div class="thumbnail">
                                                    <a href="/static/Pictures/{{ pic.file_path }}">
                                                        <img src="/static/staticPictures/index_file_picture.jpg"
                                                             style="width: 100%">

                                                        <div class="caption">
                                                            {% set filename=pic.file_path.split('/') %}
                                                            <button class="btn btn-block btn-default"
                                                                    id="file_id{{ pic.id }}"
                                                                    type="button"
                                                                    style="white-space: normal; word-break: break-all">
                                                            <span class="text-justify">
                                                                {{ filename[filename|length-1] }}
                                                            </span>
                                                            </button>
                                                            <br>


                                                    </a>
                                                    {% if current_user.is_authenticated %}
                                                        <form class=""
                                                              action="{{ url_for('delete_history_image', img_id=pic.id, board_id=g_board.code) }}"
                                                              method="post">
                                                            <button class="btn btn-default btn-sm" type="button"
                                                                    data-toggle="collapse" data-target="#{{ pic.id }}"
                                                                    aria-expanded="false"
                                                                    aria-controls="{{ pic.id }}"><span
                                                                    class="glyphicon glyphicon-remove"></span></button>
                                                            <div class="collapse" id="{{ pic.id }}">
                                                                <div class="">
                                                                    <br><br>
                                                                    <button class="btn btn-danger btn-sm btn-block"
                                                                            type="submit"><span
                                                                            class="glyphicon glyphicon-ok pull-left"></span>
                                                                        <strong>Delete?</strong>
                                                                    </button>
                                                                </div>
                                                            </div>

                                                        </form>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            </div>

                                        {% endif %}
                                    {% endfor %}

                                {% endif %}
                            {% if current_user.username!='Guest' %}
                                <form action="{{ url_for('board_history_add_file', history_id=row.id, board_id=g_board.code) }}"
                                      method="post" class="" enctype="multipart/form-data"
                                      id="{{row.id|string+'new_upfile_form'}}">

                                    <input class="hidden" name="{{row.id|string+'new_upfile'}}" id="{{row.id|string+'new_upfile'}}"
                                           type="file" value="upload"
                                           onchange="document.getElementById('{{row.id|string+'new_upfile_button'}}').click()">
                                    <button class="hidden" type="submit" id="{{row.id|string+'new_upfile_button'}}"></button>
                                    <button class="btn btn-default btn-sm" type="button"
                                            onclick="document.getElementById('{{row.id|string+'new_upfile'}}').click()"><span
                                            class="glyphicon glyphicon-paperclip"></span></button>
                                </form>

                            {% endif %}
                        </div>
                    </div>

                    <div class="panel-body" id="{{ row.id }}">{{ row.history | safe }}</div>
                    <div class="panel-footer">
                    <span>
                    <kbd class="footnote">
                        <a style="color: white"
                           href="mailto:{{ row.added_by.email }}?Subject={{ "Your comment:  "+ request.url+"#"+"comment_id"+row.id|string }}">
                    {{ "added by "+row.added_by.username|string }}
                    </a>
                </kbd>
                </span>

                        {% if not row.edited_by %}

                            <kbd class="footnote"
                                 style="position: absolute; right: 40px">{{ "last edited on "+row.time_and_date }}</kbd>

                        {% endif %}
                        {% if row.edited_by %}
                            <kbd class="footnote pull-right"
                                 style="position: absolute; right: 40px">
                                <a style="color: white"
                                   href="mailto:{{ row.edited_by.email }}?Subject={{ "Your change of  "+ request.url+"#"+"comment_id"+row.id|string }}">
                                    {{ "last edited on "+row.last_edited+" by "+row.edited_by.username|string }}
                                </a>

                            </kbd>
                        {% endif %}
                        {% if current_user.username!='Guest' %}
                            <button type="button" class="btn btn-danger btn-xs" style="position: absolute; right: 2px  "
                                    data-toggle="modal"
                                    data-target="#edit{{ modal_id }}">Edit!
                            </button>
                        {% endif %}

                        <div class="container">
                            <div id="edit{{ modal_id }}" class="modal fade" role="dialog">
                                <div class="modal-dialog">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <button type="button" class="close" data-dismiss="modal">&times;</button>
                                            <h4 class="modal-title">{{ 'Edit Comment:' }}</h4>
                                        </div>
                                        <div class="modal-body">
                                            {% set f=edit_form.history.process_data(row.history.replace('<br>', '\n')) %}
                                            {% set g=edit_form.history_id.process_data(row.id) %}
                                            <form action="" method="post">
                                                {{ wtf.form_field(edit_form.history) }}
                                                {% if current_user.username != 'Guest' %}
                                                    {{ wtf.form_field(edit_form.send_edit) }}
                                                    {{ wtf.form_field(edit_form.delete) }}
                                                {% endif %}
                                                {{ edit_form.history_id(value=row.id|string) }}
                                                {{ edit_form.hidden_tag }}
                                            </form>
                                            <div class="modal-footer">
                                            </div>
                                        </div>

                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    </div>
                {% endfor %}


                <script> {# this script is for changing the color of the targeted div when open e.g. th elink from a mail #}
                function change_color_when_div_is_called() {
                    var hash = window.location.hash.substr(1);
                    var myDiv = document.getElementById(hash);
                    myDiv.className = "panel panel-collapse panel-primary" //myDiv.className.replace(/(?:^|\s)panel-default(?!\S)/g , 'panel-primary');
                    myDiv.style.backgroundColor = 'rgba(46, 111, 194, 0.3)'


                }


                window.onload = change_color_when_div_is_called();


                </script>

            {% endif %}



    {% endif %}
    </div>

    <div id="addModal" class="modal fade" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">{{ 'Add a new Comment to '+g_board.code }}</h4>
                </div>
                <div class="modal-body">
                    {{ wtf.quick_form(add_form) }}
                    {{ add_form.hidden_tag }}
                    <div class="modal-footer">
                    </div>
                </div>

            </div>
        </div>


    </div>


{%- endblock %}


